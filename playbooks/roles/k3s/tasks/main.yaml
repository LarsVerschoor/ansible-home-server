# Install basic dependencies
- name: Install K3s Requirements
  ansible.builtin.apt:
      update_cache: true
      pkg:
          - policycoreutils
      state: present

# Check if K3s is already installed
- name: Check if K3S is already installed
  ansible.builtin.stat:
      path: /usr/local/bin/k3s
  register: k3s_installed

# Download the K3s install script if not present
- name: Download K3s installation script
  ansible.builtin.get_url:
      url: https://get.k3s.io
      dest: /tmp/k3s_install.sh
      mode: '0755'
  when: not k3s_installed.stat.exists

# Install Initial Master (single-node)
- name: Install K3s initial master
  ansible.builtin.shell: |
      sh /tmp/k3s_install.sh \
        --cluster-init \
        --disable=traefik \
        --flannel-backend=vxlan
  args:
      executable: /bin/bash
  when: node_type == 'k3s_initial_master' and not k3s_installed.stat.exists
  run_once: true
